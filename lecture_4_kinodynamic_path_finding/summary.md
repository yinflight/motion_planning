# 总结

## 1. kinodynamic

kinodynamic: Kinematic + Dynamic

## 2. State Lattice Planning

### 2.1 目的

由于机器人的运动在一些情况下会受到运动学或者动力学的限制，比方说汽车不能平移，因此再将机器人看做质点，将不再满足实际情况，因此需要从动力学和运动学限制的角度下，为机器人规划一条可行的路径。

### 2.2 控制空间和状态空间

**控制空间**：选择一个控制量，然后对控制量施加一个固定的时间T，将会得到一个末运动状态；

**状态空间**：选择一个状态量，然后找到连接起始状态和末状态的轨迹。

> 很明显控制空间下生成运动轨迹非常容易，只需要对控制量进行积分即可，很容易应用，但是它规划的效率较低，没有一个目的性。而状态空间的规划效率很高，有很强的任务导向，但是应用起来比较复杂，需要做复杂的运算。

## 3. Boundary Value Problem

对于控制空间的采样，其原理很简单，就是对控制量执行积分就能获得运动轨迹。但是对于状态空间的采样就比较复杂了，在只有起始状态和终止状态已知的情况下规划一条轨迹，很明显满足这样的路径有很多，目前就是从这些路径中找到最优的一条。

### 3.1 Optimal Boundary Value Problem (OBVP)

所谓最优边界值问题(OBVP)就是在满足起始和终止状态下的所有轨迹中选择一条代价最小的轨迹。在路径规划任务中，多数情况下可以选择**输入最小控制量**为目的，得到一条最优路径。

对于无人机的路径规划，在选择**输入最小控制量**为代价函数时，可以如下表示：
$$
J_k = \frac{1}{T} \int_0^Tj_{k}(t)^2dt \tag{1}
$$
$j$是$jerk$，它是加速度的导数，$k$表示无人机三个轴$x,y,z$，$J_{\Sigma} = J_x + J_y + J_z$

**无人机的系统模型**

无人机系统的状态量$s_k = (p_k, v_k, a_k)$，系统的输入为$u_k = j_k$，系统模型为：
$$
\dot s_k = f_s(s_k, u_k)=(v_k, a_k, j_k) \tag{2}
$$
根据Pontryagin的最小值原则，将系统模型中的所有变量单独拿出来用$\lambda =(\lambda_1, \lambda_2, \lambda_3) = (v, a, j)$表示。($\lambda$叫做谐态)

则定义无人机Hamiltonian函数：
$$
H(s, u, v) = \frac{1}{T}j^2 + \lambda^T f_s(s, u) = \frac{1}{T}j^2 + \lambda_1 v + \lambda_2 a + \lambda_3j \tag{3}
$$
根据最小值原则(PPT p26)，可以对Hamiltonian函数求出最优解。

**Pontryagin minimum principle**

广义最优控制中，Pontryagin minimum principle可以被写成如下形式：
$$
J = h(s(t)) + \int_0^Tg(s(t), u(t))dt \tag{4}
$$
$h(s(t))$：终止状态的惩罚项，表示机器人离终止状态的差距；

$\int_0^Tg(s(t), u(t))dt$：表示系统从0到t时刻的能量损耗。

对于无人机系统，如果对终止条件中的某些变量的状态做了限制，那么如果末状态没有达到要求则$h(s(T)) = \infty$(达到则为0)，将会导致该状态不满足minimum principle原则中的边界条件，因为$h(s(t))$将不可导。

> 对于终止状态中的变量，如果状态没有限制，则必须使用终止条件，不然方程的解个数不够。

根据(4)式，则广义情形下的Hamiltonian函数和斜态如下：
$$
H(s,u,\lambda) = g(s,u) + \lambda^Tf(s, u) \\ 
\lambda = (\lambda_1, \lambda_2, \lambda_3)\tag{5}
$$
通过(5)式求解得到最优的状态和控制等。

**以无人机为例探索OBVP问题**

无人机的系统方程为(对$x,y,z$轴分别考虑，所以去掉下标$k$)：
$$
\dot s = f_s(s, u)=(v, a, j) \tag{6}
$$
状态变量：$s = (p,v,a)$，输入：$j = u$

则Hamiltonian函数如下：
$$
H(s,u,\lambda) = \frac{1}{T}j^2 + \lambda_1 v + \lambda_2 a + \lambda_3 j  \\
= \frac{1}{T} j^2 + \lambda_1 v + \lambda_2 a + \lambda_3 j \tag{7}
$$
根据minimum principle，则：(假设此时最优状态$s^*$和控制$u^*$已知)
$$
\dot \lambda = - \nabla_s H(s^{*}, u^{*}, \lambda) = (0, -\lambda_1, -\lambda_2) \tag{8}
$$
对(8)式进行积分，由于$\lambda_1$的导数是0，所以$\lambda_1$的积分是常数，同理对$\lambda_2, \lambda_3$进行积分，最终得到：
$$
\lambda(t) = \frac{1}{T} [-2\alpha, 2\alpha t + 2\beta, -\alpha t^2 - 2\beta t-2 \gamma] \tag{9}
$$
根据minimum principle则最优控制量$u^*$
$$
u^*(t) = \arg \min_{u(t)}H(s^*(t), u(t), \lambda(t)) \\
 = \frac{1}{2} \alpha t^2 + \beta t + \gamma \tag{10}
$$
式(10)的求解方法为，求导之后将极值为零的点带入$H$.

将(10)式进行积分，然后考虑机器人初始状态，就能得到$s^*(t)$的最优状态方程。

$u^*(t)$和$s^*(t)$中$\alpha, \beta, \gamma$均为未知量，此时通过T时刻的边界条件，可以求解出。最终可以确定$\lambda$，通过对$\lambda_3 = j$进行积分运算，可以得到$J$，则最终的代价函数也能确定，它是一个关于T的方程。类似的还可以对J进行求解得到最小J时候的最优T。

> 具体过程参考PPT p29

> 通过上面的过程可以看出来，如果终止状态均已知，则$\alpha, \beta, \gamma$可以求解出来，但是有时终止状态未知，则此时就需要就状态未知的变量使用minimum principle中的边界条件。

## 4. Heuristic

对于考虑了运动和动力学之后的路径规划问题，它的启发函数可以从两个角度看：

- 假设没有障碍物，此时只考虑运动和动力学约束；
- 假设没有动力学约束，只考虑障碍物约束。

## 5. Hybrid A*

Hybrid A*算法是对对控制空间进行采样，因此它会空间生成很多的基于动力学约束的轨迹，此时轨迹的生成将会非常耗费计算时间。所以就必须采用一些策略来解决这个问题，例如剪枝和使用栅格地图，每个栅格只保留一个状态，如果新的状态的cost更新，则更新。

Hybrid A*算法的核心思想就是解决lattice graph过于稠密的问题。比方说机器人当前在某一个山各种，那么此时需要进行下一步的路径搜索，根据控制空间搜索原则，选择不用的控制量，然后进行路径搜索，如果某一个栅格中已经有了一个状态，则此时进行状态代价对比，只保留小的那个。这样做的意义在于每一个栅格中只有一个状态，这样就可以大幅度减少lattice graph的分之数量。

Hybrid A* 算法与A star算法相比，其在算法结构上相似，但是细节处有一些差异，其中$f(n) = g(n) + h(n)$，其中$g(n)$的计算不在像A star中的使用的是栅格距离，在Hybrid A*中$g(n)$则表示从起始状态到当前状态的动力学和运动学代价。

> 另外，对于Hybrid A* 算法可以添加一些工程上的tricks，比方说在执行一定次数的搜索之后，执行一次从当前状态到终止状态的搜索，如果刚好搜索出一条路径可行，那么就结束当前搜索。

## 5. Kinodynamic RRT*

TODO
